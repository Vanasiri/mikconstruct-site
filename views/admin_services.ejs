<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin ‚Äì ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Services</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <!-- Navbar + Sidebar -->
  <%- include('partials/admin_nav') %>

  <div class="container py-4">

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° Service Card -->
    <h2 class="h4 mb-3">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Service Card</h2>
    <form
      id="add-service-form"
      class="row g-3 mb-5 align-items-end"
      action="/admin/services/add"
      method="POST"
      enctype="multipart/form-data"
    >
      <div class="col-md-3">
        <label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
        <input
          type="text"
          name="title"
          class="form-control"
          placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"
          required
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
        <textarea
          name="text"
          class="form-control"
          rows="1"
          placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"
          required
        ></textarea>
      </div>
      <div class="col-md-2">
        <label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
        <input
          type="file"
          name="image"
          class="form-control"
          accept="image/*"
          required
        />
      </div>
      <div class="col-md-1">
        <label class="form-label">‡∏™‡∏µ</label>
        <input
          type="color"
          id="add-colorPicker"
          class="form-control form-control-color"
          value="#0E2A47"
        />
      </div>
      <div class="col-md-1">
        <label class="form-label">‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™</label>
        <input
          type="range"
          id="add-opacityRange"
          class="form-range"
          min="0" max="1" step="0.01"
          value="0.7"
        />
      </div>
      <input type="hidden" name="color" id="add-colorValue"/>
      <div class="col-md-2">
        <button class="btn btn-primary w-100">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
    </form>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö Service Cards -->
    <h2 class="h4 mb-3">üóÇÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Service Cards</h2>
    <div class="list-group shadow-sm">
      <% cards.forEach(card => { %>
      <div class="list-group-item">
        <div class="row g-2 align-items-center">
          
          <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
          <form
            data-id="<%= card.id %>"
            class="edit-service-form col-11 row g-2 align-items-center"
            action="/admin/services/edit/<%= card.id %>"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="col-md-1">
              <label class="form-label">‡∏•‡∏≥‡∏î‡∏±‡∏ö</label>
              <input
                type="number"
                name="seq"
                class="form-control"
                value="<%= card.seq %>"
              />
            </div>
            <div class="col-md-3">
              <label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
              <input
                type="text"
                name="title"
                class="form-control"
                value="<%= card.title %>"
                required
              />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏™‡∏µ</label>
              <input
                type="color"
                class="form-control form-control-color edit-colorPicker"
              />
            </div>
            <div class="col-md-2">
              <label class="form-label">‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™</label>
              <input
                type="range"
                class="form-range edit-opacityRange"
                min="0" max="1" step="0.01"
              />
            </div>
            <input
              type="hidden"
              name="color"
              class="edit-colorValue"
              value="<%= card.color %>"
            />
            <div class="col-md-2">
              <label class="form-label">‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</label>
              <% if (card.image_path) { %>
                <img
                  src="<%= card.image_path %>"
                  class="img-thumbnail mb-1"
                  style="max-height:60px;"
                />
              <% } %>
              <input type="file" name="new_image" class="form-control"/>
            </div>
            <div class="col-md-2">
              <label class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
              <textarea
                name="text"
                class="form-control"
                rows="1"
                required
              ><%= card.text %></textarea>
            </div>
            <div class="col-auto">
              <button class="btn btn-success btn-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>

          <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏ö -->
          <div class="col-1 text-end">
            <form
              action="/admin/services/delete"
              method="POST"
              onsubmit="return confirm('‡∏•‡∏ö Service Card ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');"
            >
              <input type="hidden" name="id" value="<%= card.id %>" />
              <button class="btn btn-danger btn-sm">‡∏•‡∏ö</button>
            </form>
          </div>

        </div>
      </div>
      <% }) %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï RGBA
    function toHex(r, g, b) {
      return "#" + ((1 << 24) | (r << 16) | (g << 8) | b)
        .toString(16)
        .slice(1)
        .toUpperCase();
    }
    function rgbaToComponents(rgba) {
      const m = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
      return m
        ? [parseInt(m[1]), parseInt(m[2]), parseInt(m[3]), parseFloat(m[4])]
        : [0, 0, 0, 1];
    }

    // 1) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°
    const addColorPicker = document.getElementById("add-colorPicker");
    const addOpacityRange = document.getElementById("add-opacityRange");
    const addColorValue  = document.getElementById("add-colorValue");
    function updateAddColor() {
      const hex = addColorPicker.value;
      const opacity = addOpacityRange.value;
      const bigint = parseInt(hex.slice(1), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      addColorValue.value = `rgba(${r},${g},${b},${opacity})`;
    }
    addColorPicker.addEventListener("input", updateAddColor);
    addOpacityRange.addEventListener("input", updateAddColor);
    updateAddColor();

    // 2) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î
    document.querySelectorAll(".edit-service-form").forEach((form) => {
      const id = form.dataset.id;
      const picker  = form.querySelector(".edit-colorPicker");
      const range   = form.querySelector(".edit-opacityRange");
      const hidden  = form.querySelector(".edit-colorValue");
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ initial ‡∏à‡∏≤‡∏Å hidden ‚Üí picker, range
      const [r, g, b, a] = rgbaToComponents(hidden.value);
      picker.value = toHex(r, g, b);
      range.value = a;
      function updateEditColor() {
        const hex = picker.value;
        const opacity = range.value;
        const bigint = parseInt(hex.slice(1), 16);
        const rr = (bigint >> 16) & 255;
        const gg = (bigint >> 8) & 255;
        const bb = bigint & 255;
        hidden.value = `rgba(${rr},${gg},${bb},${opacity})`;
      }
      picker.addEventListener("input", updateEditColor);
      range.addEventListener("input", updateEditColor);
      updateEditColor();
    });
  });
  </script>
</body>
</html>
